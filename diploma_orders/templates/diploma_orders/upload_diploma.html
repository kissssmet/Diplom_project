<!-- diploma_orders/templates/diploma_orders/upload_diploma.html -->
{% extends 'admin/base_site.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–ø–ª–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–ø–ª–æ–º–µ:</h5>
                        <p><strong>–¢–µ–º–∞:</strong> {{ diploma.topic }}</p>
                        <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> {{ diploma.student.get_full_name }}</p>
                        <p><strong>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ diploma.supervisor.get_full_name }}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h5>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:</h5>
                        {% if diploma.file %}
                            <div class="alert alert-success">
                                <i class="fas fa-file"></i> 
                                <strong>{{ diploma.file.name|basename }}</strong>
                                <span class="badge bg-secondary">{{ diploma.get_file_extension }}</span>
                                <br>
                                <small>–ó–∞–≥—Ä—É–∂–µ–Ω: {{ diploma.file.size|filesizeformat }}</small>
                                <div class="mt-2">
                                    <a href="{{ diploma.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                    </a>
                                    <a href="{% url 'diploma_orders:download_diploma' diploma.id %}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteFile()">
                                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> –§–∞–π–ª –¥–∏–ø–ª–æ–º–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                            </div>
                        {% endif %}
                    </div>
                    
                    <hr>
                    
                    <h5>{% if diploma.file %}–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª{% else %}–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª{% endif %}</h5>
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                            {{ form.file }}
                            <div class="form-text">
                                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOCX, DOC, TXT, JPG, PNG (–º–∞–∫—Å. 10MB)
                            </div>
                            {% if form.file.errors %}
                                <div class="alert alert-danger">
                                    {{ form.file.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'diploma_orders:student_detail' diploma.student.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> {% if diploma.file %}–ó–∞–º–µ–Ω–∏—Ç—å{% else %}–ó–∞–≥—Ä—É–∑–∏—Ç—å{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function deleteFile() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –¥–∏–ø–ª–æ–º–∞?')) {
        fetch('{% url "diploma_orders:delete_diploma_file" diploma.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        });
    }
}

// AJAX –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–Ω–∞–ª–∏–∑–∞
            window.location.href = '{% url "diploma_orders:diploma_analysis" diploma.id %}';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>

<style>
.card {
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    border: none;
}

.alert {
    border: none;
    border-radius: 10px;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn {
    border-radius: 8px;
    padding: 10px 20px;
}
</style>
{% endblock %} 