<!-- diploma_orders/templates/diploma_orders/includes/ai_widget.html -->
<div id="ai-widget" class="ai-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <div class="card shadow-lg" style="width: 350px; max-height: 500px; display: none;" id="ai-chat-container">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">üéì –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –¥–∏–ø–ª–æ–º—É</h6>
            <button type="button" class="btn-close btn-close-white" onclick="toggleAIChat()"></button>
        </div>
        <div class="card-body p-0" style="overflow-y: auto; max-height: 400px;" id="ai-chat-messages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
        <div class="card-footer">
            <div class="input-group">
                <input type="text" class="form-control" id="ai-question-input" 
                       placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –¥–∏–ø–ª–æ–º—É...">
                <button class="btn btn-primary" type="button" onclick="askAIQuestion()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="mt-2" id="ai-suggestions">
                <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
            </div>
        </div>
    </div>
    
    <button class="btn btn-primary rounded-circle p-3 shadow" onclick="toggleAIChat()" id="ai-toggle-btn">
        <i class="fas fa-robot fa-2x"></i>
    </button>
</div>

<script>
let aiContextId = null;
let currentPageText = '';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–ò-–≤–∏–¥–∂–µ—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    currentPageText = collectPageText();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ò–ò –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
    if (typeof window.showAIWidget !== 'undefined' && window.showAIWidget) {
        document.getElementById('ai-widget').style.display = 'block';
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∏–ø–ª–æ–º–∞
    if (window.location.pathname.includes('/diploma/')) {
        generatePageQuestions();
    }
});

function collectPageText() {
    // –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const mainContent = document.querySelector('main, .content, .container') || document.body;
    return mainContent.innerText.substring(0, 5000); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
}

function toggleAIChat() {
    const container = document.getElementById('ai-chat-container');
    const button = document.getElementById('ai-toggle-btn');
    
    if (container.style.display === 'none' || !container.style.display) {
        container.style.display = 'block';
        button.style.display = 'none';
        
        // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        if (!aiContextId) {
            addAIMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–ø–ª–æ–º–Ω—ã–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å –ø–æ –≤–∞—à–µ–º—É –¥–∏–ø–ª–æ–º—É, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å!');
            showAISuggestions();
        }
    } else {
        container.style.display = 'none';
        button.style.display = 'block';
    }
}

function addAIMessage(text, isUser = false) {
    const messagesDiv = document.getElementById('ai-chat-messages');
    const messageDiv = document.createElement('div');
    
    messageDiv.className = `p-3 ${isUser ? 'bg-light text-end' : 'bg-white'}`;
    messageDiv.innerHTML = `
        <div class="d-flex ${isUser ? 'justify-content-end' : ''}">
            ${!isUser ? '<div class="me-2"><i class="fas fa-robot text-primary"></i></div>' : ''}
            <div class="p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-light'}">
                ${text}
            </div>
            ${isUser ? '<div class="ms-2"><i class="fas fa-user text-muted"></i></div>' : ''}
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function askAIQuestion() {
    const input = document.getElementById('ai-question-input');
    const question = input.value.trim();
    
    if (!question) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addAIMessage(question, true);
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingId = 'ai-loading-' + Date.now();
    addAIMessage('<div class="spinner-border spinner-border-sm text-primary"></div> –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/api/ai/ask/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            question: question,
            context: currentPageText,
            page_id: getCurrentPageId()
        })
    })
    .then(response => response.json())
    .then(data => {
        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const messagesDiv = document.getElementById('ai-chat-messages');
        messagesDiv.removeChild(messagesDiv.lastChild);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        addAIMessage(data.answer);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º context_id
        aiContextId = data.context_id;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        if (data.suggested_questions && data.suggested_questions.length > 0) {
            showAISuggestions(data.suggested_questions);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addAIMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    });
}

function showAISuggestions(suggestions = null) {
    const suggestionsDiv = document.getElementById('ai-suggestions');
    suggestionsDiv.innerHTML = '';
    
    const defaultSuggestions = [
        '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–æ—Ä–º–∞—Ç—É –ì–û–°–¢',
        '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∑–∞—â–∏—Ç—ã',
        '–ù–∞–ø–∏—Å–∞—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é –Ω–∞ —Ä–∞–±–æ—Ç—É',
        '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏–ø–ª–æ–º–∞'
    ];
    
    const questions = suggestions || defaultSuggestions;
    
    questions.forEach(question => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary btn-sm me-1 mb-1';
        button.textContent = question;
        button.onclick = () => {
            document.getElementById('ai-question-input').value = question;
            askAIQuestion();
        };
        suggestionsDiv.appendChild(button);
    });
}

function generatePageQuestions() {
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const pageText = collectPageText();
    
    if (pageText.length < 100) return; // –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
    
    fetch('/api/ai/generate-questions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            text: pageText,
            page: getCurrentPageNumber()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.questions && data.questions.length > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –±–ª–æ–∫–µ
            showGeneratedQuestions(data.questions);
        }
    });
}

function showGeneratedQuestions(questions) {
    const container = document.createElement('div');
    container.className = 'card mt-3';
    container.innerHTML = `
        <div class="card-header">
            <h6 class="mb-0">ü§ñ –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∑–∞—â–∏—Ç—ã (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –ò–ò)</h6>
        </div>
        <div class="card-body">
            <ol class="mb-0">
                ${questions.map(q => `<li>${q.text} <span class="badge bg-secondary">${q.difficulty}</span></li>`).join('')}
            </ol>
        </div>
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const mainContent = document.querySelector('main, .content, .container') || document.body;
    mainContent.appendChild(container);
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function getCurrentPageId() {
    // –ü–æ–ª—É—á–∞–µ–º ID —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
    return document.body.dataset.pageId || null;
}

function getCurrentPageNumber() {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ URL –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö
    const match = window.location.pathname.match(/page-(\d+)/);
    return match ? parseInt(match[1]) : 1;
}
</script>

<style>
.ai-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

#ai-chat-messages::-webkit-scrollbar {
    width: 6px;
}

#ai-chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#ai-chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

#ai-chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>